name: ğŸš€ Deploy Grace Note to Google Play Store

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger from GitHub
    inputs:
      track:
        description: 'Play Store Track'
        required: true
        default: 'internal'
        type: choice
        options:
        - internal
        - alpha
        - beta
        - production

jobs:
  deploy:
    name: ğŸ“± Build & Deploy to Play Store
    runs-on: ubuntu-latest
    
    steps:
    # ğŸ“¥ Checkout code
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # â˜• Setup Java
    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    # ğŸ¦ Setup Flutter
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    # ğŸ“¦ Get dependencies
    - name: ğŸ“¦ Install Dependencies
      run: flutter pub get
      
    # ğŸ§ª Run tests
    - name: ğŸ§ª Run Tests
      run: flutter test
      
    # ğŸ” Analyze code
    - name: ğŸ” Analyze Code
      run: flutter analyze
      
    # ğŸ” Setup Android Signing
    - name: ğŸ” Setup Android Signing
      env:
        SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        SIGNING_KEY_STORE_BASE64: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
      run: |
        # Create keystore directory
        mkdir -p android/app/keystore
        
        # Decode and save keystore
        echo "$SIGNING_KEY_STORE_BASE64" | base64 -d > android/app/keystore/release.keystore
        
        # Create key.properties file
        cat > android/key.properties << EOF
        storePassword=$SIGNING_STORE_PASSWORD
        keyPassword=$SIGNING_KEY_PASSWORD
        keyAlias=$SIGNING_KEY_ALIAS
        storeFile=keystore/release.keystore
        EOF
        
    # ğŸ”¢ Auto-increment version
    - name: ğŸ”¢ Auto-increment Version
      run: |
        # Get current version from pubspec.yaml
        CURRENT_VERSION=$(grep "version:" pubspec.yaml | cut -d ' ' -f 2)
        
        # Extract version number and build number
        VERSION_NUMBER=$(echo $CURRENT_VERSION | cut -d '+' -f 1)
        BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d '+' -f 2)
        
        # Increment build number
        NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
        NEW_VERSION="${VERSION_NUMBER}+${NEW_BUILD_NUMBER}"
        
        # Update pubspec.yaml
        sed -i "s/version: .*/version: $NEW_VERSION/" pubspec.yaml
        
        echo "ğŸ”¢ Version updated to: $NEW_VERSION"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        
    # ğŸ—ï¸ Build Android App Bundle
    - name: ğŸ—ï¸ Build Android App Bundle (AAB)
      run: |
        flutter build appbundle --release \
          --build-name=$(echo $NEW_VERSION | cut -d '+' -f 1) \
          --build-number=$(echo $NEW_VERSION | cut -d '+' -f 2)
          
    # ğŸ“Š Generate What's New
    - name: ğŸ“Š Generate Release Notes
      run: |
        mkdir -p android/app/src/main/play/release-notes/ko-KR
        cat > android/app/src/main/play/release-notes/ko-KR/default.txt << EOF
        ğŸ™ ê·¸ë ˆì´ìŠ¤ë…¸íŠ¸ ì—…ë°ì´íŠ¸
        
        âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥:
        â€¢ íí‹°ë…¸íŠ¸ì™€ ì„¤êµë…¸íŠ¸ ì‘ì„± ê°œì„ 
        â€¢ ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ ê°•í™”
        â€¢ ì—°ì† ê¸°ë¡ ì¶”ì  ê¸°ëŠ¥
        
        ğŸ› ë²„ê·¸ ìˆ˜ì • ë° ì„±ëŠ¥ ê°œì„ 
        
        ğŸ“± ë” ë‚˜ì€ ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•œ UI/UX ê°œì„ 
        EOF
        
    # ğŸ” Setup Google Play API Key
    - name: ğŸ” Setup Google Play Service Account
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > android/app/google-play-service-account.json
        
    # ğŸ“¤ Deploy to Google Play
    - name: ğŸ“¤ Deploy to Google Play Store
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: com.thousandemfla.grace_notes
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: ${{ github.event.inputs.track || 'internal' }}
        status: completed
        inAppUpdatePriority: 2
        whatsNewDirectory: android/app/src/main/play/release-notes/
        
    # ğŸ‰ Success notification
    - name: ğŸ‰ Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ ê·¸ë ˆì´ìŠ¤ë…¸íŠ¸ ì•±ì´ ì„±ê³µì ìœ¼ë¡œ Google Play Storeì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“± Track: ${{ github.event.inputs.track || 'internal' }}"
        echo "ğŸ”¢ Version: $NEW_VERSION"
        
    # âŒ Failure notification  
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        
    # ğŸ§¹ Cleanup
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        rm -f android/app/keystore/release.keystore
        rm -f android/key.properties
        rm -f android/app/google-play-service-account.json