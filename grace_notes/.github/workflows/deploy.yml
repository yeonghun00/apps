name: ðŸš€ Deploy Grace Note to Google Play Store

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger from GitHub
    inputs:
      track:
        description: 'Play Store Track'
        required: true
        default: 'internal'
        type: choice
        options:
        - internal
        - alpha
        - beta
        - production

jobs:
  deploy:
    name: ðŸ“± Build & Deploy to Play Store
    runs-on: ubuntu-latest
    
    steps:
    # ðŸ“¥ Checkout code
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # â˜• Setup Java
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    # ðŸ¦ Setup Flutter
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
        cache: true
        
    # ðŸ” Verify Setup
    - name: ðŸ” Verify Flutter & Dart Versions
      run: |
        flutter --version
        dart --version
        flutter doctor -v
        
    # ðŸ“¦ Get dependencies
    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get
      
    # ðŸ§ª Run tests
    - name: ðŸ§ª Run Tests
      run: flutter test
      
    # ðŸ” Analyze code
    - name: ðŸ” Analyze Code
      run: flutter analyze
      
    # ðŸ” Setup Android Signing
    - name: ðŸ” Setup Android Signing
      env:
        SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        SIGNING_KEY_STORE_BASE64: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
      run: |
        # Create keystore directory
        mkdir -p android/app/keystore
        
        # Decode and save keystore
        echo "$SIGNING_KEY_STORE_BASE64" | base64 -d > android/app/keystore/release.keystore
        
        # Create key.properties file
        cat > android/key.properties << EOF
        storePassword=$SIGNING_STORE_PASSWORD
        keyPassword=$SIGNING_KEY_PASSWORD
        keyAlias=$SIGNING_KEY_ALIAS
        storeFile=keystore/release.keystore
        EOF
        
    # ðŸ”¢ Auto-increment version
    - name: ðŸ”¢ Auto-increment Version
      run: |
        # Get current version from pubspec.yaml
        CURRENT_VERSION=$(grep "version:" pubspec.yaml | cut -d ' ' -f 2)
        
        # Extract version number and build number
        VERSION_NUMBER=$(echo $CURRENT_VERSION | cut -d '+' -f 1)
        BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d '+' -f 2)
        
        # Increment build number
        NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
        NEW_VERSION="${VERSION_NUMBER}+${NEW_BUILD_NUMBER}"
        
        # Update pubspec.yaml
        sed -i "s/version: .*/version: $NEW_VERSION/" pubspec.yaml
        
        echo "ðŸ”¢ Version updated to: $NEW_VERSION"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        
    # ðŸ—ï¸ Build Android App Bundle
    - name: ðŸ—ï¸ Build Android App Bundle (AAB)
      run: |
        flutter build appbundle --release \
          --build-name=$(echo $NEW_VERSION | cut -d '+' -f 1) \
          --build-number=$(echo $NEW_VERSION | cut -d '+' -f 2)
          
    # ðŸ“Š Generate What's New
    - name: ðŸ“Š Generate Release Notes
      run: |
        mkdir -p android/app/src/main/play/release-notes/ko-KR
        cat > android/app/src/main/play/release-notes/ko-KR/default.txt << EOF
        ðŸ™ ê·¸ë ˆì´ìŠ¤ë…¸íŠ¸ ì—…ë°ì´íŠ¸
        
        âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥:
        â€¢ íí‹°ë…¸íŠ¸ì™€ ì„¤êµë…¸íŠ¸ ìž‘ì„± ê°œì„ 
        â€¢ ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ ê°•í™”
        â€¢ ì—°ì† ê¸°ë¡ ì¶”ì  ê¸°ëŠ¥
        
        ðŸ› ë²„ê·¸ ìˆ˜ì • ë° ì„±ëŠ¥ ê°œì„ 
        
        ðŸ“± ë” ë‚˜ì€ ì‚¬ìš©ìž ê²½í—˜ì„ ìœ„í•œ UI/UX ê°œì„ 
        EOF
        
    # ðŸŽ‰ Build Success (skip Play Store upload for now)
    - name: ðŸŽ‰ Build Completed Successfully
      run: |
        echo "ðŸŽ‰ ê·¸ë ˆì´ìŠ¤ë…¸íŠ¸ ì•± ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ðŸ“± Version: $NEW_VERSION"
        echo "ðŸ“¦ AAB file: build/app/outputs/bundle/release/app-release.aab"
        
        # Show file size
        ls -lh build/app/outputs/bundle/release/app-release.aab
        
    # ðŸ§¹ Cleanup
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        rm -f android/app/keystore/release.keystore
        rm -f android/key.properties